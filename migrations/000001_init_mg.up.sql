
-- migrate -path ./migrations -database "postgresql://postgres:postgres@localhost:6543/postgres?sslmode=disable" -verbose up

CREATE TABLE IF NOT EXISTS roles (
     id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     role_name varchar(255)
);

CREATE TABLE IF NOT EXISTS users (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username varchar(255) unique not null,
    password_hash varchar(255) not null,
    role_id int references roles(id) not null,
    name varchar(255) not null,
    surname varchar(255) not null,
    created_at timestamptz,
    updated_at timestamptz
);

CREATE TABLE IF NOT EXISTS lessons (
    id int PRIMARY KEY,
    name varchar(255)
);

CREATE TABLE IF NOT EXISTS student_lesson (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    student_id int references users(id) on delete cascade,
    lesson_id int references lessons(id) on delete cascade,
    CONSTRAINT uq_student_lesson_student_lesson UNIQUE (student_id, lesson_id)
);

CREATE TABLE IF NOT EXISTS marks (
    id int GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    teacher_id int references users(id) on delete cascade,
    student_id int references users(id) on delete cascade,
    lesson_id int references lessons(id) on delete cascade,
    home_work_grade int not null check (home_work_grade >= 1 or home_work_grade < 6 ),
    attendance_grade int not null check (attendance_grade = 0 or attendance_grade = 1),
    date date not null,
    CONSTRAINT fk_student_lesson
        FOREIGN KEY (student_id, lesson_id)
        REFERENCES student_lesson(student_id, lesson_id)
);


INSERT INTO roles(id, role_name) VALUES (1, 'teacher');
INSERT INTO roles(id, role_name) VALUES (2, 'student');
INSERT INTO roles(id, role_name) VALUES (3, 'admin');
INSERT INTO roles(id, role_name) VALUES (4, 'guest');